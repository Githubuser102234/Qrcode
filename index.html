<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, Timestamp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
  import QRious from "https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.module.min.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCgTjWZcxFVg6UmJDb56XnQ0kPe64QoSvE",
    authDomain: "qrcode-bdf3a.firebaseapp.com",
    projectId: "qrcode-bdf3a",
    storageBucket: "qrcode-bdf3a.firebasestorage.app",
    messagingSenderId: "433946415670",
    appId: "1:433946415670:web:deae6dbea3d9494b2abe97",
    measurementId: "G-PSMQDNJ024"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const showError = (msg, err) => {
    console.error(msg, err);
    document.getElementById("displayText").innerText = "‚ùå " + msg;
  };

  const uid = location.hash.replace('#', '');

  if (uid) {
    document.getElementById("inputSection").style.display = "none";
    try {
      const ref = doc(db, "qrTexts", uid);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        const data = snap.data();
        const createdAt = data.createdAt?.toDate?.();
        if (createdAt) {
          const now = new Date();
          const ageDays = (now - createdAt) / (1000 * 60 * 60 * 24);
          if (ageDays > 3) {
            document.getElementById("displayText").innerText = "‚ö†Ô∏è This message has expired.";
          } else {
            document.getElementById("displayText").innerText = data.text;
          }
        } else {
          document.getElementById("displayText").innerText = data.text;
        }
      } else {
        document.getElementById("displayText").innerText = "‚ùå Message not found.";
      }
    } catch (e) {
      showError("Failed to fetch QR data.", e);
    }
  }

  document.getElementById("generateBtn").onclick = async () => {
    const text = document.getElementById("textInput").value.trim();
    if (!text) return alert("Please enter some text.");

    const id = Math.random().toString(36).substring(2, 10);
    const ref = doc(db, "qrTexts", id);
    try {
      console.log("‚è≥ Saving to Firestore...");
      await setDoc(ref, {
        text,
        createdAt: Timestamp.fromDate(new Date())
      });
      console.log("‚úÖ Saved!");

      const url = `${location.origin}${location.pathname}#${id}`;
      document.getElementById("shareLink").href = url;
      document.getElementById("shareLink").innerText = url;
      document.getElementById("outputSection").style.display = "block";

      console.log("üéØ Generating QR...");
      new QRious({
        element: document.getElementById('qr'),
        value: url,
        size: 200
      });
      console.log("‚úÖ QR Generated:", url);
    } catch (e) {
      showError("Failed to create QR code.", e);
    }
  };
</script>
